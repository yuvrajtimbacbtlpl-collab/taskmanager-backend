import { useEffect, useState } from "react";
import { api } from "../../api";
import {
  DataTable,
  PageHeader,
  SearchBar,
  ActionButtons,
  FormModal,
  FormField,
  ConfirmModal,
} from "../../components";
import { useAuth } from "../../context/AuthContext";
import socket from "../../socket";

const BASE_URL = "http://localhost:4000";

export default function CreateTask() {
  const { user, hasPermission } = useAuth();

  const canCreate = hasPermission("task.create");
  const canUpdate = hasPermission("task.update");
  const canDelete = hasPermission("task.delete");
  const canRead   = hasPermission("task.read");

  const [tasks, setTasks] = useState([]);
  const [staff, setStaff] = useState([]);
  const [statuses, setStatuses] = useState([]);

  const [search, setSearch] = useState("");
  const [selectedStatus, setSelectedStatus] = useState("");
  const [selectedStaff, setSelectedStaff] = useState("");

  const [showForm, setShowForm] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [message, setMessage] = useState("");
  const [viewTask, setViewTask] = useState(null);
  const [deleteId, setDeleteId] = useState(null);

  const [form, setForm] = useState({
    title: "",
    description: "",
    assignedTo: "",
    status: "",
    media: null,
    mediaUrl: "",
  });

  useEffect(() => {
    if (user?._id) socket.emit("join", user._id);
  }, [user]);

  useEffect(() => {
    if (canRead) {
      fetchTasks();
      fetchStaff();
      fetchStatuses();
    }
  }, [canRead]);

  useEffect(() => {
    socket.on("taskCreated", fetchTasks);
    socket.on("taskUpdated", fetchTasks);
    socket.on("taskDeleted", fetchTasks);
    socket.on("staffUpdated", fetchStaff);

    return () => {
      socket.off("taskCreated");
      socket.off("taskUpdated");
      socket.off("taskDeleted");
      socket.off("staffUpdated");
    };
  }, []);

  const fetchTasks    = async () => { const d = await api("/tasks");             setTasks(d || []); };
  const fetchStaff    = async () => { const d = await api("/auth/staff");         setStaff((d || []).filter((s) => s._id !== user?._id)); };
  const fetchStatuses = async () => { const d = await api("/task-status/active"); setStatuses(d || []); };

  const filteredTasks = tasks.filter((task) => {
    const matchesSearch  = task.title?.toLowerCase().includes(search.toLowerCase()) || task.description?.toLowerCase().includes(search.toLowerCase());
    const matchesStatus  = !selectedStatus || task.status === selectedStatus;
    const matchesStaff   = !selectedStaff  || task.assignedTo?._id === selectedStaff;
    return matchesSearch && matchesStatus && matchesStaff;
  });

  const resetForm = () => {
    setForm({ title: "", description: "", assignedTo: "", status: "", media: null, mediaUrl: "" });
    setEditingId(null);
    setShowForm(false);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    try {
      const formData = new FormData();
      formData.append("title",       form.title);
      formData.append("description", form.description);
      formData.append("status",      form.status);
      formData.append("assignedTo",  form.assignedTo);
      formData.append("sendMail",    "true");
      if (form.media) formData.append("media", form.media);

      if (editingId) {
        await api(`/tasks/${editingId}`, { method: "PUT", body: formData });
      } else {
        await api("/tasks", { method: "POST", body: formData });
      }

      setMessage("Task saved âœ…");
      resetForm();
      fetchTasks();
    } catch (err) {
      setMessage(err.message);
    }
  };

  const handleEdit = (task) => {
    setViewTask(null);
    setForm({
      title:       task.title || "",
      description: task.description || "",
      assignedTo:  task.assignedTo?._id || "",
      status:      task.status || "",
      media:       null,
      mediaUrl:    task.media ? `${BASE_URL}/uploads/${task.media}` : "",
    });
    setEditingId(task._id);
    setShowForm(true);
  };

  const confirmDelete = async () => {
    await api(`/tasks/${deleteId}`, { method: "DELETE" });
    setDeleteId(null);
    setMessage("Deleted ðŸ—‘ï¸");
    fetchTasks();
    setTimeout(() => setMessage(""), 3000);
  };

  const updateTaskInline = async (row, updates) => {
    const formData = new FormData();
    formData.append("title",       row.title);
    formData.append("description", row.description);
    formData.append("assignedTo",  updates.assignedTo || row.assignedTo?._id);
    formData.append("status",      updates.status     || row.status);
    await api(`/tasks/${row._id}`, { method: "PUT", body: formData });
    fetchTasks();
  };

  const columns = [
    { header: "Title", accessor: "title" },
    {
      header: "Status",
      render: (row) => (
        <select
          className="table-select"
          value={row.status}
          onClick={(e) => e.stopPropagation()}
          onChange={(e) => updateTaskInline(row, { status: e.target.value })}
        >
          {statuses.map((s) => (
            <option key={s._id} value={s.name}>{s.name}</option>
          ))}
        </select>
      ),
    },
    {
      header: "Assigned To",
      render: (row) => (
        <select
          className="table-select"
          value={row.assignedTo?._id || ""}
          onClick={(e) => e.stopPropagation()}
          onChange={(e) => updateTaskInline(row, { assignedTo: e.target.value })}
        >
          <option value="">Select User</option>
          {staff.map((s) => (
            <option key={s._id} value={s._id}>{s.username}</option>
          ))}
        </select>
      ),
    },
  ];

  const actions =
    canUpdate || canDelete || canRead
      ? (row) => (
          <ActionButtons
            onEdit={() => handleEdit(row)}
            onDelete={() => setDeleteId(row._id)}
            onView={() => setViewTask(row)}
            canEdit={canUpdate}
            canDelete={canDelete}
            canView={true}
          />
        )
      : null;

  if (!canRead) {
    return (
      <div className="permission-page">
        <h3>No Permission to view tasks</h3>
      </div>
    );
  }

  return (
    <div className="permission-page">
      <PageHeader
        title="Task Management"
        btnLabel={canCreate ? "+ Create Task" : undefined}
        onBtnClick={() => { setShowForm(true); setEditingId(null); }}
      />

      {message && <div className="info-msg">{message}</div>}

      {/* â”€â”€ Filter bar â”€â”€ */}
      <div className="filter-bar">
        <div className="filter-left">
          <SearchBar
            value={search}
            onChange={setSearch}
            placeholder="Search title or description..."
          />
        </div>

        <div className="filter-right-group">
          <select value={selectedStatus} onChange={(e) => setSelectedStatus(e.target.value)}>
            <option value="">All Status</option>
            {statuses.map((s) => (
              <option key={s._id} value={s.name}>{s.name}</option>
            ))}
          </select>

          <select value={selectedStaff} onChange={(e) => setSelectedStaff(e.target.value)}>
            <option value="">All Staff</option>
            {staff.map((s) => (
              <option key={s._id} value={s._id}>{s.username}</option>
            ))}
          </select>
        </div>
      </div>

      <DataTable columns={columns} data={filteredTasks} actions={actions} />

      {/* â”€â”€ View Modal â”€â”€ */}
      {viewTask && (
        <FormModal title="Task Details" onClose={() => setViewTask(null)}>
          <div className="task-details">
            <p><strong>Title:</strong> {viewTask.title}</p>
            <p><strong>Description:</strong> {viewTask.description}</p>
            <p><strong>Status:</strong> {viewTask.status}</p>
            <p><strong>Assigned To:</strong> {viewTask.assignedTo?.username}</p>

            {viewTask.media && (
              <div style={{ marginTop: 15 }}>
                {viewTask.media.match(/\.(mp4|mov|webm)$/i) ? (
                  <video src={`${BASE_URL}/uploads/${viewTask.media}`} width="300" controls />
                ) : (
                  <img src={`${BASE_URL}/uploads/${viewTask.media}`} width="250" alt="task" />
                )}
              </div>
            )}
          </div>
        </FormModal>
      )}

      {/* â”€â”€ Create / Edit Modal â”€â”€ */}
      {showForm && (
        <FormModal
          title={editingId ? "Edit Task" : "Create Task"}
          onClose={resetForm}
        >
          <form onSubmit={handleSubmit}>
            <FormField
              label="Title"
              value={form.title}
              onChange={(val) => setForm({ ...form, title: val })}
            />

            <FormField
              label="Description"
              type="textarea"
              value={form.description}
              onChange={(val) => setForm({ ...form, description: val })}
            />

            <FormField
              label="Assign To"
              type="select"
              value={form.assignedTo}
              onChange={(val) => setForm({ ...form, assignedTo: val })}
            >
              <option value="">Select Staff</option>
              {staff.map((s) => (
                <option key={s._id} value={s._id}>{s.username}</option>
              ))}
            </FormField>

            <FormField
              label="Status"
              type="select"
              value={form.status}
              onChange={(val) => setForm({ ...form, status: val })}
            >
              <option value="">Select Status</option>
              {statuses.map((s) => (
                <option key={s._id} value={s.name}>{s.name}</option>
              ))}
            </FormField>

            {/* Media upload â€” kept as-is (file inputs can't use FormField) */}
            <div className="field">
              <label>Upload Image / Video</label>

              {editingId && form.mediaUrl && !form.media && (
                <div style={{ marginBottom: 8 }}>
                  <p style={{ fontSize: 13, color: "#666" }}>
                    Current File: <b style={{ marginLeft: 5 }}>{form.mediaUrl.split("/").pop()}</b>
                  </p>
                </div>
              )}

              <input
                type="file"
                accept="image/*,video/*"
                onChange={(e) => setForm({ ...form, media: e.target.files[0] })}
              />

              {editingId && form.mediaUrl && !form.media && (
                <div style={{ marginTop: 10 }}>
                  {form.mediaUrl.match(/\.(mp4|mov|webm)$/i) ? (
                    <video src={form.mediaUrl} width="200" controls />
                  ) : (
                    <img src={form.mediaUrl} width="150" alt="task" style={{ borderRadius: 6 }} />
                  )}
                </div>
              )}

              {form.media && (
                <div style={{ marginTop: 10 }}>
                  <p style={{ fontSize: 13 }}>New File:</p>
                  {form.media.type.startsWith("video") ? (
                    <video src={URL.createObjectURL(form.media)} width="200" controls />
                  ) : (
                    <img src={URL.createObjectURL(form.media)} width="150" alt="preview" />
                  )}
                </div>
              )}
            </div>

            <button className="btn-primary full">
              {editingId ? "Update Task" : "Create Task"}
            </button>
          </form>
        </FormModal>
      )}

      {/* â”€â”€ Delete Confirm â”€â”€ */}
      {deleteId && (
        <ConfirmModal
          message="Are you sure you want to delete this task?"
          onConfirm={confirmDelete}
          onCancel={() => setDeleteId(null)}
        />
      )}
    </div>
  );
}
